882
Chapter 9
Virtual Memory
Aside
Relaxing the monotonicity assumption
We could relax the monotonically nondecreasing assumption in our deﬁnition of Uk and allow the heap
to grow up and down by letting Hk be the high-water mark over the ﬁrst k + 1 requests.
9.9.4
Fragmentation
The primary cause of poor heap utilization is a phenomenon known as fragmen-
tation, which occurs when otherwise unused memory is not available to satisfy
allocate requests. There are two forms of fragmentation: internal fragmentation
and external fragmentation.
Internal fragmentation occurs when an allocated block is larger than the pay-
load. This might happen for a number of reasons. For example, the implementation
of an allocator might impose a minimum size on allocated blocks that is greater
than some requested payload. Or, as we saw in Figure 9.34(b), the allocator might
increase the block size in order to satisfy alignment constraints.
Internal fragmentation is straightforward to quantify. It is simply the sum of
the differences between the sizes of the allocated blocks and their payloads. Thus,
at any point in time, the amount of internal fragmentation depends only on the
pattern of previous requests and the allocator implementation.
External fragmentation occurs when there is enough aggregate free memory
to satisfy an allocate request, but no single free block is large enough to handle
the request. For example, if the request in Figure 9.34(e) were for eight words
rather than two words, then the request could not be satisﬁed without requesting
additional virtual memory from the kernel, even though there are eight free words
remaining in the heap. The problem arises because these eight words are spread
over two free blocks.
External fragmentation is much more difﬁcult to quantify than internal frag-
mentation because it depends not only on the pattern of previous requests and the
allocator implementation but also on the pattern of future requests. For example,
suppose that after k requests all of the free blocks are exactly four words in size.
Does this heap suffer from external fragmentation? The answer depends on the
pattern of future requests. If all of the future allocate requests are for blocks that
are smaller than or equal to four words, then there is no external fragmentation.
On the other hand, if one or more requests ask for blocks larger than four words,
then the heap does suffer from external fragmentation.
Since external fragmentation is difﬁcult to quantify and impossible to predict,
allocators typically employ heuristics that attempt to maintain small numbers of
larger free blocks rather than large numbers of smaller free blocks.
9.9.5
Implementation Issues
The simplest imaginable allocator would organize the heap as a large array of
bytes and a pointer p that initially points to the ﬁrst byte of the array. To allocate
